<% layout("/layouts/boilerplate.ejs") %>

  <body>
    <div class="container mt-1 pt-4">
      <!-- Heading -->
      <div class="row mb-4">
        <div class="col-12 text-center">
          <h3 class="fw-bold">
            <%= info.title %>
          </h3>
        </div>
      </div>

      <!-- Card -->
      <div class="row justify-content-center">
        <div class="col-md-8">
          <div class="card shadow-sm listing-card">
            <img src="<%= info.image.url %>" class="card-img-top show-img" alt="listing_img">
            <div class="card-body">
              <!-- <h5 class="card-title"> info.title %></h5> -->
              <p class="card-text mt-2">
                <span class="border rounded-pill px-3 py-1 bg-light text-secondary small">
                  <i class="fa-solid fa-user-circle me-1 text-success"></i>
                  Owned by <strong>
                    <%= info.owner.username %>
                  </strong>
                </span>
              </p>

              <p class="card-text">
                <%= info.description %>
              </p>
              <p class="fw-semibold text-success">&#8377;<%= info.price %>
              </p>
              <ul class="list-unstyled">
                <li><i class="bi bi-geo-alt"></i>
                  <%= info.location %>
                </li>
                <li><i class="bi bi-flag"></i>
                  <%= info.country %>
                </li>
              </ul>

              <!-- Buttons -->
              <% if(currentUser && currentUser._id.equals(info.owner._id)){ %>
                <div class="d-flex justify-content-between mt-4">
                  <a href="/listings/<%= info._id %>/edit" class="btn btn-primary">
                    Edit Property
                  </a>
                  <form action="/listings/<%= info.id %>?_method=DELETE" method="post">
                    <button class="btn btn-danger">Delete</button>
                  </form>
                </div>
                <% } %>
            </div>
          </div>
        </div>
      </div>

      <!-- Map Section -->
      <!-- Map Section -->
      <div class="row justify-content-center mt-4">
        <div class="col-md-8">
          <div id="map" class="card shadow-sm" style="height: 400px;" data-lat="<%= info.lat || 30.7333 %>"
            data-lng="<%= info.lng || 76.7794 %>" data-title="<%= info.title %>">
          </div>
        </div>
      </div>



      <% if(currentUser){ %>
        <div class="row justify-content-center mt-5">
          <div class="col-md-8">
            <div class="card shadow-sm p-4">

              <h4 class="text-center mb-3">Leave a Review</h4>
              <form action="/listings/<%= info._id %>/review" method="POST" class="needs-validation" novalidate>

                <!-- Rating -->
                <div class="mb-3">
                  <label for="rating" class="form-label fw-semibold">Rating</label>
                  <select class="form-select" id="rating" name="review[rating]">
                    <option value="">Choose...</option>
                    <option value="5">⭐⭐⭐⭐⭐ - Excellent</option>
                    <option value="4">⭐⭐⭐⭐ - Very Good</option>
                    <option value="3">⭐⭐⭐ - Good</option>
                    <option value="2">⭐⭐ - Fair</option>
                    <option value="1">⭐ - Poor</option>
                  </select>
                </div>

                <!-- Comment -->
                <div class="mb-3">
                  <label for="comment" class="form-label fw-semibold">Comment</label>
                  <textarea class="form-control" id="comment" name="review[comment]" rows="4"
                    placeholder="Write your review..." required></textarea>
                  <div class="invalid-feedback">Please Write A Comment</div>
                </div>

                <!-- Submit -->
                <div class="d-grid">
                  <button type="submit" class="btn btn-success">Submit Review</button>
                </div>

              </form>
            </div>
          </div>
        </div>
        <% } %>

          <!-- Review Shows -->
          <!-- All Reviews Section -->
          <h4 style="margin-top: 10px;">All Reviews</h4>
          <div class="row">
            <% info.reviews.forEach(r=> { %>
              <div class="card mb-2 col-6">
                <div class="card-body">
                  <div class="card-title">
                    <strong>
                      <%= r.author ? r.author.username : "Unknown" %>
                    </strong>
                  </div>
                  <div class="card-text">
                    <%= r.comment %>
                  </div>
                  <div class="card-text">⭐ <%= r.rating %>
                  </div>
                  <% if(currentUser && r.author && currentUser._id.equals(r.author._id)) { %>
                    <form action="/listings/<%= info._id %>/review/<%= r._id %>?_method=DELETE" method="post"
                      class="mt-2">
                      <button class="btn btn-sm btn-danger">Delete</button>
                    </form>
                    <% } %>
                </div>
              </div>
              <% }) %>
          </div>



    </div>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const mapDiv = document.getElementById('map');
        const lat = parseFloat(mapDiv.dataset.lat);
        const lng = parseFloat(mapDiv.dataset.lng);
        const title = mapDiv.dataset.title;

        const map = L.map('map').setView([lat, lng], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        L.marker([lat, lng]).addTo(map)
          .bindPopup(title)
          .openPopup();
      });
    </script>


  </body>